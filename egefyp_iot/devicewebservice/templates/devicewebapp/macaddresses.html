
{% load static %}
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
  <canvas id="myChart" style="width:100%;max-width:700px"></canvas>
  <title></title>
    {% comment %} <script>
        document.write('<h1>MQTT Data Page</h1>'+Date()+' <br>');
        setTimeout(function(){
            location.reload();
        },1000);
    </script> {% endcomment %}
</head>

{% block body_block %}
<body>
    <div class='container'>
        <div class='row'>
            <div class="col-10 mx-auto mt-5">
                <h1 id='app'>{{ text }}</h1>
            </div>
        </div>
    </div>
    <!-- script src="{% static "main.js" %}"></!-->
    <script>
        var canvas = document.getElementById('myChart'),
            ctx = canvas.getContext('2d'),
            startingData = {
                labels: [10,9,8,7,6,5,4,3,2,1,0],
                datasets: [
                {   
                    label: 'Device #1',
                    backgroundColor: [
                        'rgba(73, 198, 230, 0.5)',
                    ],
                    borderWidth: 1,
                    data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0]
                },
                {
                    label: 'Device #2', 
                    backgroundColor: [
                        'rgba(255, 99, 71, 0.5)',
                    ],
                    borderWidth: 1,
                    data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0]
                }
            ]
        };
        
        const socket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/devicewebapp/mac_add/'
        );
        
        socket.onmessage = function(e){
            const data = JSON.parse(e.data);

            // Access the data properties (connected_devices and signal_list)
            const connectedDevices = data.connected_devices;
            const signalList = data.signal_list;

            /*for (var i = 0; i < connectedDevices.length; i++) {

                hostname = connectedDevices[i][0];
                ip_address = connectedDevices[i][1];
                mac_address = connectedDevices[i][2];

                // Host: LAPTOP-1KKIANDS
                document.querySelector('#hostname').innerText = hostname;
                // IP Address: 
                document.querySelector('#ip_address').innerText = ip_address;

                // MAC Address:  5C:CF:7F:3E:9A:84
                document.querySelector('#mac_address').innerText = mac_address.toUpperCase();

                for (var x = 0; x < signalList.length; x++){
                  if (signalList[x][0] == mac_address){
                    // Signal Strength: 
                    document.querySelector('#signalstrength').innerText = signalList[x][1];
                  };
                    
                };
            };*/



            // Use the data as needed
            console.log('Connected Devices:', connectedDevices);
            console.log('Signal List:', signalList);

            //Shows the signal strength
            document.querySelector('#app').innerText = signalList[0][2];
            
            //Displaying the signal strength onto the Chart
            var newGraphData = myLiveChart.data.datasets[0].data; // make the dataset[0] become newGraphData
            newGraphData.shift(); // remove the first item from array

            dBm = signalList[0][2];
            let quality = 2 * (dBm + 100);

            newGraphData.push(quality); // add the new value to the end
            myLiveChart.update();


            //var djangoData = JSON.parse(e.data);
            //console.log(djangoData);
            

            /*var currentTime = new Date(); // Get the current time
            var timeString = currentTime.toLocaleTimeString(); // Format the time as a string
            newGraphxLabel = myLiveChart.data.labels;
            newGraphxLabel.shift(); // Remove the oldest entry in the x-axis (time)
            newGraphxLabel.push(timeString);*/
            
            // Change the value of the text to randint
            //document.querySelector('#app').innerText = signal_list;
        }
        var myLiveChart = new Chart(ctx, {type: 'line', data: startingData, options: {
            animation: {duration: 15},
            scales: {
                xAxes: [{
                    scaleLabel:{
                        display: true, 
                        labelString: 'Time(s)'
                    }
                }],
                yAxes: [{
                    ticks: {min:0, max:100},
                    scaleLabel: {
                        display: true,
                        labelString: 'Signal Strength (%)'
                    }
                }],
            }
        }});
    </script>
    <h2>There are <span id="no_of_devices"></span> devices connected to this network through this device.</h2>
    <!-- for host, status in hosts_list  -->
    
<div>
    <!-- for hostname, ip_address, mac in connected_devices -->
    {% for device in connectedDevices %}
    <br>
    <table style="border: 3px black solid; padding: 10px; border-radius: 20px; width: 300px;">
        <tr>
            <td><strong>Host: </strong><span id="hostname">{{ device.0 }}</span></td>
        </tr>
        <tr>
            <td><strong>IP Address: </strong><span id="ip_address">{{ device.1 }}</span></td>
        </tr>
        <tr>
            <td><strong>MAC Address: </strong><span id="mac_address">{{ device.2 }}</span></td>
        </tr>
        <tr>    
            <td><strong>Signal Strength: </strong><span id="signalstrength"></span></td>
        </tr>
    </table>
    <br>
{% endfor %}
</div>
<!-- endfor -->
{{ signal_list }}
{{ connected_devices }}
</body>
{% endblock %}


<html lang="en" dir="ltr">
