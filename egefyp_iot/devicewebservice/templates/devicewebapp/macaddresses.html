
{% load static %}
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
  <canvas id="myChart" style="width:100%;max-width:700px"></canvas>
  <title></title>
    {% comment %} <script>
        document.write('<h1>MQTT Data Page</h1>'+Date()+' <br>');
        setTimeout(function(){
            location.reload();
        },1000);
    </script> {% endcomment %}
</head>

{% block body_block %}
<body>
    <div class='container'>
        <div class='row'>
            <div class="col-10 mx-auto mt-5">
                <h1 id='app'>{{ text }}</h1>
            </div>
        </div>
    </div>
    <!-- script src="{% static "main.js" %}"></!-->
    <script>
        var canvas = document.getElementById('myChart'),
            ctx = canvas.getContext('2d'),
            startingData = {
                labels: [10,9,8,7,6,5,4,3,2,1,0],
                datasets: [
                {   
                    label: 'Device #1',
                    backgroundColor: [
                        'rgba(73, 198, 230, 0.5)',
                    ],
                    borderWidth: 1,
                    data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0]
                },
                {
                    label: 'Device #2', 
                    backgroundColor: [
                        'rgba(255, 99, 71, 0.5)',
                    ],
                    borderWidth: 1,
                    data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0]
                }
            ]
        };
        
        const socket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/devicewebapp/mac_add/'
        );
        
        socket.onmessage = function(e){
            //const data = JSON.parse(e.data);

            // Access the data properties (connected_devices and signal_list)
            //const connectedDevices = data.connected_devices;
            //const signalList = data.signal_list;

            // Use the data as needed
            //console.log('Connected Devices:', connectedDevices);
            //console.log('Signal List:', signalList);
            
            var djangoData = JSON.parse(e.data);
            console.log(djangoData);
            //var newGraphData = myLiveChart.data.datasets[0].data; // make the dataset[0] become newGraphData
            //newGraphData.shift(); // remove the first item from array
            //newGraphData.push(djangoData['value']); // add the new value to the end

            /*var currentTime = new Date(); // Get the current time
            var timeString = currentTime.toLocaleTimeString(); // Format the time as a string
            newGraphxLabel = myLiveChart.data.labels;
            newGraphxLabel.shift(); // Remove the oldest entry in the x-axis (time)
            newGraphxLabel.push(timeString);*/
            myLiveChart.update();
            // Change the value of the text to randint
            document.querySelector('#app').innerText = signal_list;
        }
        var myLiveChart = new Chart(ctx, {type: 'line', data: startingData, options: {
            animation: {duration: 15},
            scales: {
                xAxes: [{
                    scaleLabel:{
                        display: true, 
                        labelString: 'Time(s)'
                    }
                }],
                yAxes: [{
                    ticks: {min:0, max:100},
                    scaleLabel: {
                        display: true,
                        labelString: 'Signal Strength (%)'
                    }
                }],
            }
        }});
    </script>
    <h2>There are {{ connected_devices|length }} devices connected to this network through this device.</h2>
    <!-- for host, status in hosts_list  -->
    
<div>
    {% for hostname, ip_address, mac in connected_devices %}
    <!-- name of variable must be in order of the index of data in the list,eg. hostname = connected_devices[0] -->
    <br>
    <table style="border: 3px black solid; padding: 10px; border-radius: 20px; width: 300px;">
    <tr>
        <td><strong>Host:</strong> {{ hostname }}</td>
    </tr>
    <tr>
        <td><strong>IP Address:</strong> {{ ip_address }}</td>
    </tr>
    <tr>
        <td><strong>MAC Address:</strong> {{ mac }}</td>
    </tr>
    <tr>    
        <td><strong>Signal Strength:</strong>
            
            {% for signal in signal_list %}
                {% if signal.0 == mac %}
                    {{ signal.1 }}
                    {% if signal.2 > -30 %}
                        <img src="{% static 'wifi_4bar.png' %}" alt="image not found" class="center" width="20px">
                    {% elif signal.2 > -67 %}
                        <img src="{% static 'wifi_3bar.png' %}" alt="image not found" class="center" width="20px">
                    {% elif signal.2 > -70 %}
                        <img src="{% static 'wifi_2bar.png' %}" alt="image not found" class="center" width="20px">
                    {% elif signal.2 > -80 %}
                        <img src="{% static 'wifi_1bar.png' %}" alt="image not found" class="center" width="20px">
                    {% elif signal.2 > -90 %}
                        <img src="{% static 'wifi_nobar.png' %}" alt="image not found" class="center" width="20px">
                    {% endif %}
                {% endif %}
            {% endfor %}    
        </td>
    </tr>
    </table>
    <br>
</div>
{% endfor %}
{{ signal_list }}
{{ connected_devices }}
</body>
{% endblock %}


<html lang="en" dir="ltr">
